# release_build.yaml
name: Web Release Build

# Controls when the workflow will run
on:
  workflow_call:
    inputs:
      FLAVOUR:
        required: true
        type: string
        default: "production"
      runs_on:
        required: false
        type: string
        default: "ubuntu-latest"
      new_engine:
        required: false
        type: string
        default: "true"
      secrets_list:
        required: false
        type: string
        default: '[]'
      folder_max_mb_size:
        required: false
        type: number
        default: 3

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout

jobs:
  build:
    runs-on: ${{inputs.runs_on}} # We are using ubuntu to deploy flutter web
    timeout-minutes: 20
    environment: ${{inputs.FLAVOUR}}
    permissions: # set permissions for AWS creentials specifically
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.5
      - name: Set Up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ vars.NODE_FRAMEWORK_VERSION }}
      - name: üì¶ Install Dependencies
       # npm ci instead of npm install to not overwrite package_lock.json
        run: npm install
      # Otherwise, run the legacy build command.
      - name: Build the Web static pages (legacy)
        if: ${{ inputs.new_engine != 'true' }}
        run: npm run pages:build
      - name: Deploy to Cloudflare Pages (legacy)
        if: ${{ inputs.new_engine != 'true' }}
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{secrets.CLOUDFLARE_API_TOKEN}}
          accountId: ${{secrets.CLOUDFLARE_ACCOUNT_ID}}
          command: pages deploy
          packageManager: npm

      - name: Check size
        if: ${{ inputs.new_engine == 'true' }}
        env:
          MAX_SIZE_MB: ${{ inputs.folder_max_mb_size }}
        run: |
          # Run the check-size script defined in package.json
          npm run check-size

          # Calculate the size of the output directory in MB
          BUNDLE_SIZE=$(du -sm boundled | cut -f1)
          echo "Total build size: ${BUNDLE_SIZE} MB"

          # Ensure MAX_SIZE_MB is set (default to 3MB if empty)
          MAX_SIZE_MB=${MAX_SIZE_MB:-3}

          # If the bundle size exceeds the limit, stop the workflow
          if [ "$BUNDLE_SIZE" -gt "$MAX_SIZE_MB" ]; then
            echo "üö®‚ùå Build size exceeds ${MAX_SIZE_MB}MB limit! Stopping deployment."
            exit 1
          else
            echo "‚úÖ Build size is within the ${MAX_SIZE_MB}MB limit."
          fi
          
      - name: Deploy to Cloudflare Pages (new)
        if: ${{ inputs.new_engine == 'true' }}
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{secrets.CLOUDFLARE_API_TOKEN}}
          accountId: ${{secrets.CLOUDFLARE_ACCOUNT_ID}}
          command: deploy
          packageManager: npm
          environment: ${{ inputs.FLAVOUR != 'production' && inputs.FLAVOUR || '' }}
          preCommands: npm run pre-deploy
        env:
          NEXT_PUBLIC_FIREBASE_CONFIG: ${{ secrets.NEXT_PUBLIC_FIREBASE_CONFIG }}
          NEXT_PUBLIC_RECAPTCHA_V3_SITE_KEY: ${{ secrets.NEXT_PUBLIC_RECAPTCHA_V3_SITE_KEY }}
          NEXT_PUBLIC_FLAVOUR: ${{ inputs.FLAVOUR }}
  notify:
    if: always() # Ensures this job runs regardless of the completion status of dependent jobs
    needs:
      - build
    uses: ./.github/workflows/notification.yml
    secrets: inherit
    with:
      job_status: ${{ needs.build.result }}
      workflow: ${{ github.workflow }}
      runs_on: ${{inputs.runs_on}}
