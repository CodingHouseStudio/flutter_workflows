name: Notify

on:
  workflow_call:
    inputs:
      job_status:
        required: true
        type: string
      workflow:
        required: true
        type: string
      dop_text:
        required: false
        type: string
        default: ""
      runs_on:
        required: false
        type: string
        default: "ubuntu-latest"
      trigger_actor:
        required: false
        type: string
        default: ""
      pr_title:
        required: false
        type: string
        default: ""

jobs:
  notification:
    timeout-minutes: 3
    runs-on: ${{ inputs.runs_on }}
    steps:
      # 1. Map User and save to OUTPUT (not env)
      - name: Map GitHub User to Telegram
        id: map_user
        run: |
          GH_USER="${{ inputs.trigger_actor }}"

          case "$GH_USER" in
            "DemianKryk") TG_USER="@demiankryk" ;;
            "AndrewKrash") TG_USER="@andriikrash" ;;
            "mykhailokurochkinwork") TG_USER="@kurochkinmy" ;;
            "herman-the-worm") TG_USER="@hermankravchenko" ;;
            *) TG_USER="$GH_USER" ;;
          esac

          # Write to GITHUB_OUTPUT
          echo "tg_user=$TG_USER" >> $GITHUB_OUTPUT

      # 2. Use steps.map_user.outputs.tg_user
      - name: Send Telegram Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            *${{ inputs.job_status == 'success' && 'âœ… Build Successful' || 'âŒ Build Failed' }}*

            ğŸ”¹ *Repo:* `${{ github.event.repository.name }}`
            ğŸ”¹ *Branch:* `${{ github.head_ref || github.ref_name }}`
            ğŸ”¹ *Workflow:* ${{ inputs.workflow }}
            ${{ inputs.trigger_actor != '' && format('ğŸ‘¤ *User:* {0}', steps.map_user.outputs.tg_user) || '' }}
            ${{
              inputs.pr_title != '' &&
              format(
                'ğŸ“ *PR:* {0}',
                replace(
                  replace(
                    replace(
                      replace(
                        replace(inputs.pr_title, '_', '\\_'),
                      '*', '\\*'),
                    '[', '\\['),
                  ']', '\\]'),
                )
              )
              || ''
            }}

            ${{ inputs.dop_text != '' && format('_{0}_', inputs.dop_text) || '' }}

            [ğŸ”— View Run Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
