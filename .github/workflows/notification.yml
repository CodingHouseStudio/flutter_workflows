name: Notify

on:
  workflow_call:
    inputs:
      job_status:
        required: true
        type: string
      workflow:
        required: true
        type: string
      dop_text:
        required: false
        type: string
        default: ""
      runs_on:
        required: false
        type: string
        default: "ubuntu-latest"
      trigger_actor:
        required: false
        type: string
        default: ""
      pr_title:
        required: false
        type: string
        default: ""

jobs:
  notification:
    timeout-minutes: 3
    runs-on: ${{ inputs.runs_on }}
    steps:
      # 1. Map User and save to OUTPUT (not env)
      - name: Map GitHub User to Telegram
        id: map_user
        run: |
          GH_USER="${{ inputs.trigger_actor }}"

          case "$GH_USER" in
            "DemianKryk") TG_USER="@demiankryk" ;;
            "AndrewKrash") TG_USER="@andriikrash" ;;
            "mykhailokurochkinwork") TG_USER="@kurochkinmy" ;;
            "herman-the-worm") TG_USER="@hermankravchenko" ;;
            "ihor-greb-dev") TG_USER="@IgorGreb" ;;
            "Oleksii556") TG_USER="@darkius" ;;
            " oleksandr-mytko-codinghouse") TG_USER="@makedonsky77" ;;
            *) TG_USER="$GH_USER" ;;
          esac

          # Write to GITHUB_OUTPUT
          echo "tg_user=$TG_USER" >> $GITHUB_OUTPUT

      - name: Escape PR title for HTML
        id: escape_pr
        run: |
          PR_TITLE="${{ inputs.pr_title }}"

          PR_TITLE_ESCAPED=$(echo "$PR_TITLE" \
            | sed 's/&/\&amp;/g' \
            | sed 's/</\&lt;/g' \
            | sed 's/>/\&gt;/g')

          echo "pr_title=$PR_TITLE_ESCAPED" >> $GITHUB_OUTPUT

      # 2. Use steps.map_user.outputs.tg_user
      - name: Send Telegram Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: html
          message: |
            <b>${{ inputs.job_status == 'success' && 'âœ… Build Successful' || 'âŒ Build Failed' }}</b>
            ğŸ”¹ <b>Repo:</b> ${{ github.event.repository.name }}
            ğŸ”¹ <b>Branch:</b> ${{ github.head_ref || github.ref_name }}
            ğŸ”¹ <b>Workflow:</b> ${{ inputs.workflow }}
            ${{ inputs.trigger_actor != '' && format('ğŸ‘¤ <b>User:</b> {0}', steps.map_user.outputs.tg_user) || '' }}
            ${{ inputs.pr_title != '' && format('ğŸ“ <b>PR:</b> {0}', steps.escape_pr.outputs.pr_title) || '' }}
            <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">ğŸ”— View Run Logs</a>
